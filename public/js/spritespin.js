(function($){"use strict";var name='spritespin';var Spin={};window.SpriteSpin=Spin;Spin.namespace=name;Spin.mods={};Spin.eventNames=['mousedown','mousemove','mouseup','mouseenter','mouseover','mouseleave','dblclick','mousewheel','touchstart','touchmove','touchend','touchcancel','selectstart','gesturestart','gesturechange','gestureend'];Spin.eventsToPrevent=['dragstart'];Spin.defaults={source:undefined,width:undefined,height:undefined,frames:undefined,framesX:undefined,lanes:1,sizeMode:undefined,module:'360',behavior:'drag',renderer:'canvas',lane:0,frame:0,frameTime:10,animate:true,reverse:false,loop:true,stopFrame:0,wrap:true,wrapLane:false,sense:1,senseLane:undefined,orientation:'horizontal',detectSubsampling:true,scrollThreshold:50,preloadCount:undefined,onInit:undefined,onProgress:undefined,onLoad:undefined,onFrame:undefined,onDraw:undefined};var idCounter=0;var instances={};Spin.instances=instances;function simulateEvent(name,e){for(var id in instances){if(!instances.hasOwnProperty(id))continue;var data=instances[id];var i,module;for(i=0;i<data.mods.length;i+=1){module=data.mods[i];if(typeof module[name]!='function')continue;module[name].apply(data.target,[e,data]);}}}function bindSimulatedEvent(eName){$(window.document).bind(eName+'.'+name,function(e){simulateEvent('document'+eName,e);});}function handleResizeEvent(){for(var id in instances){if(instances.hasOwnProperty(id)){var data=instances[id];if(data.responsive){Spin.boot(data);}}}}var resizeTimeout=null;$(window).on('resize',function(){clearTimeout(resizeTimeout);resizeTimeout=setTimeout(handleResizeEvent,100);});for(var i=0;i<Spin.eventNames.length;i+=1){bindSimulatedEvent(Spin.eventNames[i]);}function pushInstance(data){idCounter+=1;data.id=idCounter;instances[idCounter]=data;}function popInstance(data){delete instances[data.id];}function padNumber(num,length,pad){num=String(num);while(num.length<length){num=String(pad)+num;}return num;}function clamp(value,min,max){return(value>max?max:(value<min?min:value));}Spin.clamp=clamp;function wrap(value,min,max,size){while(value>max){value-=size;}while(value<min){value+=size;}return value;}Spin.wrap=wrap;function prevent(e){e.preventDefault();return false;}function log(){if(window.console&&window.console.log){window.console.log.apply(window.console,arguments);}}function bind(target,event,func){if(func){target.bind(event+'.'+name,function(e){func.apply(target,[e,target.spritespin('data')]);});}}Spin.bind=bind;function unbind(target){target.unbind('.'+name);}function load(opts){var src=(typeof opts.source==='string')?[opts.source]:opts.source;var i,count=0,img,images=[],targetCount=(opts.preloadCount||src.length);var completed=false,firstLoaded=false;var tick=function(){count+=1;if(typeof opts.progress==='function'){opts.progress({index:$.inArray(this,images),loaded:count,total:src.length,percent:Math.round((count/src.length)*100)});}firstLoaded=firstLoaded||(this===images[0]);if(!completed&&(count>=targetCount)&&firstLoaded&&(typeof opts.complete==='function')){completed=true;opts.complete(images);}};for(i=0;i<src.length;i+=1){img=new Image();images.push(img);img.onload=img.onabort=img.onerror=tick;img.src=src[i];}if(typeof opts.initiated==='function'){opts.initiated(images);}}function detectSubsampling(img,size){var iw=(size||img).width;var ih=(size||img).height;if(iw*ih<=1024*1024){return false;}var canvas;canvas=document.createElement('canvas');if(!canvas||!canvas.getContext){return false;}var context=canvas.getContext('2d');if(!context){return false;}canvas.width=canvas.height=1;context.fillStyle="#FF00FF";context.fillRect(0,0,1,1);context.drawImage(img,-iw+1,0);try{var dat=context.getImageData(0,0,1,1).data;return(dat[0]===255)&&(dat[1]===0)&&(dat[2]===255);}catch(err){log(err.message,err.stack);return false;}}function naturalSize(image){if(image.naturalWidth!=null){return{width:image.naturalWidth,height:image.naturalHeight};}var img=new Image();img.src=image.src;return{width:img.width,height:img.height};}function pixelRatio(context){var devicePixelRatio=window.devicePixelRatio||1;var backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;return devicePixelRatio/backingStoreRatio;}Spin.sourceArray=function(path,opts){var fStart=0,fEnd=0,lStart=0,lEnd=0,digits=opts.digits||2;if(opts.frame){fStart=opts.frame[0];fEnd=opts.frame[1];}if(opts.lane){lStart=opts.lane[0];lEnd=opts.lane[1];}var i,j,temp,result=[];for(i=lStart;i<=lEnd;i+=1){for(j=fStart;j<=fEnd;j+=1){temp=path.replace("{lane}",padNumber(i,digits,0));temp=temp.replace("{frame}",padNumber(j,digits,0));result.push(temp);}}return result;};Spin.measureSource=function(data){var img=data.images[0];var size=naturalSize(img);if(data.images.length===1){data.sourceWidth=size.width;data.sourceHeight=size.height;if(data.detectSubsampling&&detectSubsampling(img,size)){data.sourceWidth/=2;data.sourceHeight/=2;}data.framesX=data.framesX||data.frames;if(!data.frameWidth||!data.frameHeight){if(data.framesX){data.frameWidth=Math.floor(data.sourceWidth/data.framesX);var framesY=Math.ceil((data.frames*data.lanes)/data.framesX);data.frameHeight=Math.floor(data.sourceHeight/framesY);}else{data.frameWidth=size.width;data.frameHeight=size.height;}}}else{data.sourceWidth=data.frameWidth=size.width;data.sourceHeight=data.frameHeight=size.height;if(detectSubsampling(img,size)){data.sourceWidth=data.frameWidth=size.width/2;data.sourceHeight=data.frameHeight=size.height/2;}data.frames=data.frames||data.images.length;}};Spin.resetInput=function(data){data.startX=data.startY=undefined;data.currentX=data.currentY=undefined;data.oldX=data.oldY=undefined;data.dX=data.dY=data.dW=0;data.ddX=data.ddY=data.ddW=0;};Spin.updateInput=function(e,data){if(e.touches===undefined&&e.originalEvent!==undefined){e.touches=e.originalEvent.touches;}data.oldX=data.currentX;data.oldY=data.currentY;if(e.touches!==undefined&&e.touches.length>0){data.currentX=e.touches[0].clientX||0;data.currentY=e.touches[0].clientY||0;}else{data.currentX=e.clientX||0;data.currentY=e.clientY||0;}if(data.oldX===undefined||data.oldY===undefined){data.oldX=data.currentX;data.oldY=data.currentY;}if(data.startX===undefined||data.startY===undefined){data.startX=data.currentX;data.startY=data.currentY;data.clickframe=data.frame;data.clicklane=data.lane;}data.dX=data.currentX-data.startX;data.dY=data.currentY-data.startY;data.ddX=data.currentX-data.oldX;data.ddY=data.currentY-data.oldY;data.ndX=data.dX/data.width;data.ndY=data.dY/data.height;data.nddX=data.ddX/data.width;data.nddY=data.ddY/data.height;};Spin.updateFrame=function(data,frame,lane){data.lastFrame=data.frame;data.lastLane=data.lane;if(frame!==undefined){data.frame=Number(frame);}else if(data.animation){data.frame+=(data.reverse?-1:1);}if(data.animation){data.frame=wrap(data.frame,0,data.frames-1,data.frames);if(!data.loop&&(data.frame===data.stopFrame)){Spin.stopAnimation(data);}}else if(data.wrap){data.frame=wrap(data.frame,0,data.frames-1,data.frames);}else{data.frame=clamp(data.frame,0,data.frames-1);}if(lane!==undefined){data.lane=lane;if(data.wrapLane){data.lane=wrap(data.lane,0,data.lanes-1,data.lanes);}else{data.lane=clamp(data.lane,0,data.lanes-1);}}if(data.lastFrame!=data.frame||data.lastLane!=data.lane){data.target.trigger("onFrameChanged",data);}data.target.trigger("onFrame",data);data.target.trigger("onDraw",data);};Spin.stopAnimation=function(data){data.animate=false;if(data.animation){window.clearInterval(data.animation);data.animation=null;}};Spin.setAnimation=function(data){if(data.animate){Spin.requestFrame(data);}else{Spin.stopAnimation(data);}};Spin.requestFrame=function(data){if(data.animation){return;}if(data.frameFunction===undefined){data.frameFunction=function(){try{Spin.updateFrame(data);}catch(ignore){}};}data.animation=window.setInterval(data.frameFunction,data.frameTime);};Spin.setModules=function(data){var i,modName,mod;for(i=0;i<data.mods.length;i+=1){modName=data.mods[i];if(typeof modName==='string'){mod=Spin.mods[modName];if(mod){data.mods[i]=mod;}else{$.error("No module found with name "+modName);}}}};Spin.displaySize=function(data){var w=Math.floor(data.width||data.frameWidth||data.target.innerWidth());var h=Math.floor(data.height||data.frameHeight||data.target.innerHeight());var a=w/h;return{width:w,height:h,aspect:a}}
Spin.calculateInnerLayout=function(data){var w=Math.floor(data.width||data.frameWidth||data.target.innerWidth());var h=Math.floor(data.height||data.frameHeight||data.target.innerHeight());var a=w/h;var w1=data.frameWidth||w;var h1=data.frameHeight||h;var a1=w1/h1;var css={width:'100%',height:'100%',top:0,left:0,bottom:0,right:0,position:'absolute',overflow:'hidden'};var mode=data.sizeMode;if(!mode||mode=='scale'){return css;}if(mode=='original'){css.width=w1;css.height=h1;}else if(mode=='fit'){if(a1>=a){css.width=w;css.height=w/a1;}else{css.height=h;css.width=h*a1;}}else if(mode=='fill'){if(a1>=a){css.height=h;css.width=h*a1;}else{css.width=w;css.height=w/a1;}}else{css.width=w;css.height=h;}css.width=css.width|0;css.height=css.height|0;css.top=((h-css.height)/2)|0;css.left=((w-css.width)/2)|0;css.right=css.left;css.bottom=css.top;return css;};Spin.setLayout=function(data){data.target.attr('unselectable','on').css({width:'',height:'','-ms-user-select':'none','-moz-user-select':'none','-khtml-user-select':'none','-webkit-user-select':'none','user-select':'none'});var w=Math.floor(data.width||data.frameWidth||data.target.innerWidth());var h=Math.floor(data.height||data.frameHeight||data.target.innerHeight());if(data.responsive&&(typeof window.getComputedStyle==='function')){var style=getComputedStyle(data.target[0]);if(style.width){var a=w/h;w=Number(style.width.replace('px',''))|0;h=(w/a)|0;}}data.target.css({width:w,height:h,position:'relative',overflow:'hidden'});var css=Spin.calculateInnerLayout(data);data.stage.css(css).hide();if(data.canvas){data.canvasRatio=data.canvasRatio||pixelRatio(data.context);data.canvas[0].width=(css.width*data.canvasRatio)||w;data.canvas[0].height=(css.height*data.canvasRatio)||h;data.canvas.css(css).hide();data.context.scale(data.canvasRatio,data.canvasRatio);}};Spin.setEvents=function(data){var i,j,mod,target=data.target;unbind(target);for(j=0;j<Spin.eventsToPrevent.length;j+=1){bind(target,Spin.eventsToPrevent[j],prevent);}for(i=0;i<data.mods.length;i+=1){mod=data.mods[i];for(j=0;j<Spin.eventNames.length;j+=1){bind(target,Spin.eventNames[j],mod[Spin.eventNames[j]]);}bind(target,'onInit',mod.onInit);bind(target,'onProgress',mod.onProgress);bind(target,'onLoad',mod.onLoad);bind(target,'onFrameChanged',mod.onFrameChanged);bind(target,'onFrame',mod.onFrame);bind(target,'onDraw',mod.onDraw);}bind(target,'onLoad',function(e,data){Spin.setAnimation(data);});bind(target,'onInit',data.onInit);bind(target,'onProgress',data.onProgress);bind(target,'onLoad',data.onLoad);bind(target,'onFrameChanged',mod.onFrameChanged);bind(target,'onFrame',data.onFrame);bind(target,'onDraw',data.onDraw);};Spin.boot=function(data){Spin.setModules(data);Spin.setLayout(data);Spin.setEvents(data);data.target.addClass('loading').trigger('onInit',data);data.loading=true;load({source:data.source,preloadCount:data.preloadCount,progress:function(progress){data.target.trigger('onProgress',[progress,data]);},complete:function(images){data.images=images;data.loading=false;Spin.measureSource(data);Spin.setLayout(data);data.stage.show();data.target.removeClass('loading').trigger('onLoad',data).trigger('onFrame',data).trigger('onDraw',data);}});};Spin.create=function(options){var $this=options.target;var data=$this.data(name);if(!data){data=$.extend({},Spin.defaults,options);data.source=data.source||[];$this.find('img').each(function(){data.source.push($(this).attr('src'));});$this.empty().addClass("spritespin-instance").append("<div class='spritespin-stage'></div>");if(data.renderer==='canvas'){var canvas=$("<canvas class='spritespin-canvas'></canvas>")[0];if(!!(canvas.getContext&&canvas.getContext('2d'))){data.canvas=$(canvas);data.context=canvas.getContext("2d");$this.append(data.canvas);$this.addClass('with-canvas');}else{data.renderer='image';}}data.target=$this;data.stage=$this.find(".spritespin-stage");$this.data(name,data);pushInstance(data);}else{$.extend(data,options);}if(typeof data.source==='string'){data.source=[data.source];}if(data.mods){delete data.behavior;delete data.module;}if(data.behavior||data.module){data.mods=[];if(data.behavior){data.mods.push(data.behavior);}if(data.module){data.mods.push(data.module);}delete data.behavior;delete data.module;}Spin.boot(data);};Spin.destroy=function(data){if(data){popInstance(data);Spin.stopAnimation(data);unbind(data.target);data.target.removeData(name);}};Spin.registerModule=function(name,module){if(Spin.mods[name]){$.error('Module name is already taken: '+name);}module=module||{};Spin.mods[name]=module;return module;};Spin.Api=function(data){this.data=data;};Spin.extendApi=function(methods){var key,api=Spin.Api.prototype;for(key in methods){if(methods.hasOwnProperty(key)){if(api[key]){$.error('API method is already defined: '+key);}else{api[key]=methods[key];}}}return api;};$.fn.spritespin=function(obj,value){if(obj==="data"){return this.data(name);}if(obj==="api"){var data=this.data(name);data.api=data.api||new Spin.Api(data);return data.api;}if(obj==="destroy"){return $(this).each(function(){Spin.destroy($(this).data(name));});}if(arguments.length===2&&typeof obj==='string'){var tmp={};tmp[obj]=value;obj=tmp;}if(typeof obj==='object'){obj.target=obj.target||$(this);Spin.create(obj);return obj.target;}return $.error('Invalid call to spritespin');};}(window.jQuery||window.Zepto||window.$));